!function(t,e){"use strict";function i(t,e,i,s){return new(i||(i=Promise))((function(o,n){function a(t){try{r(s.next(t))}catch(t){n(t)}}function d(t){try{r(s.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,d)}r((s=s.apply(t,e||[])).next())}))}class s{constructor(t){this.animation=t}}class o{constructor(t){this.fsm=t}}class n{constructor(){this.toPlay=[]}play(t){this.toPlay.push(t)}}class a{constructor(t){this.lifeTime=t}}class d{constructor(t=0){this.radius=t}}class r{constructor(t){this.countdown=t}}class h{constructor(t){this.displayObject=t}}class c{constructor(){this.lives=0,this.level=0,this.hits=0,this.playing=!1}setForStart(){this.lives=3,this.level=0,this.hits=0,this.playing=!0}}class l{constructor(t,e,i=0,s=0){this.shooting=!1,this.timeSinceLastShot=0,this.offsetFromParentX=t,this.offsetFromParentY=e,this.minimumShotInterval=i,this.bulletLifetime=s}}class u{constructor(t=0){this.trigger=t}}class p{constructor(t){this.view=t}}class m{constructor(t,e,i=0,s=0){this.velocityX=t,this.velocityY=e,this.angularVelocity=i,this.damping=s}}class y{constructor(t=0,e=0,i=0,s=0,o=0){this.left=t,this.right=e,this.accelerate=i,this.accelerationRate=s,this.rotationRate=o}}class g{constructor(t,e,i=0){this.x=t,this.y=e,this.rotation=i}}class w{constructor(t){this.fsm=t}}class f{constructor(t){this.startGame=!1,this.waitForStart=t,t.click.add(()=>{this.startGame=!0})}}class v extends e.Graphics{constructor(t){super();const e=2*Math.random()*Math.PI,i=Math.random()*t,s=10*Math.random()+10;this.velocityX=Math.cos(e)*s,this.velocityY=Math.sin(e)*s,this.beginFill(16777215).drawCircle(0,0,1).endFill().setTransform(Math.cos(e)*i,Math.sin(e)*i)}}class S extends e.Container{constructor(t){super(),this.dots=[];const e=S.numDots;for(let i=0;i<e;i+=1){const e=new v(t);this.addChild(e),this.dots.push(e)}}animate(t){for(const e of this.dots)e.setTransform(e.x+e.velocityX*t,e.y+e.velocityY*t)}}S.numDots=8;class x extends e.Graphics{constructor(t){super(),this.moveTo(t,0).beginFill(16777215);let e=0;for(;e<2*Math.PI;){const i=(.75+.25*Math.random())*t,s=Math.cos(e)*i,o=Math.sin(e)*i;this.lineTo(s,o),e+=.5*Math.random()}this.lineTo(t,0).endFill()}}class N extends e.Graphics{constructor(){super(),this.beginFill(16777215).drawCircle(0,0,2.5).endFill()}}class T extends e.Container{constructor(){super(),this.setTransform(400,50);const t=new e.TextStyle({fontFamily:"Arial",fontSize:20,fill:16777215});this.score=new e.Text("SCORE: 0",t),this.score.setTransform(-200-this.score.width,0),this.addChild(this.score),this.lives=new e.Text("",t),this.lives.setTransform(200,0),this.addChild(this.lives),this.setScore(0),this.setLives(3)}setScore(t){this.score.text=`SCORE: ${t}`}setLives(t){this.lives.text=`LIVES: ${t}`}}class E extends e.Container{constructor(){super(),this.shape1=new e.Graphics,this.shape1.moveTo(10,0).beginFill(16777215).lineTo(-7,7).lineTo(-4,0).lineTo(10,0).endFill(),this.addChild(this.shape1),this.shape2=new e.Graphics,this.shape2.moveTo(10,0).beginFill(16777215).lineTo(-7,-7).lineTo(-4,0).lineTo(10,0).endFill(),this.addChild(this.shape2),this.vel1x=10*Math.random()-5,this.vel1y=10*Math.random()+10,this.vel2x=10*Math.random()-5,this.vel2y=-10*Math.random()-10,this.rot1=3*Math.random()-1.5,this.rot2=3*Math.random()-1.5}animate(t){const{shape1:e,shape2:i}=this;e.setTransform(e.x+this.vel1x*t,e.y+this.vel1y*t,1,1,e.rotation+this.rot1*t),i.setTransform(i.x+this.vel2x*t,i.y+this.vel2y*t,1,1,i.rotation+this.rot2*t)}}class M extends e.Graphics{constructor(){super(),this.moveTo(10,0).beginFill(16777215).lineTo(-7,7).lineTo(-4,0).lineTo(-7,-7).lineTo(10,0).endFill()}}class k extends e.Container{constructor(){super(),this.click=new t.Signal0,this.dispatchClick=()=>{this.click.dispatch()},this.addClickListener=()=>{window.addEventListener("click",this.dispatchClick)},this.removeClickListener=()=>{window.removeEventListener("click",this.dispatchClick),this.gameOver.text="GAME OVER"};const i={fontFamily:"Arial",fill:16777215};this.gameOver=new e.Text("ASTEROIDS",new e.TextStyle(Object.assign(Object.assign({},i),{fontSize:50}))),this.gameOver.setTransform(-this.gameOver.width/2,-50),this.addChild(this.gameOver),this.clickToStart=new e.Text("Click to start",new e.TextStyle(Object.assign(Object.assign({},i),{fontSize:20}))),this.clickToStart.setTransform(-this.clickToStart.width/2,50),this.addChild(this.clickToStart),this.on("addedToStage",this.addClickListener),this.on("removedFromStage",this.removeClickListener)}}class b{constructor(t,e){this.engine=t,this.config=e}destroyEntity(t){this.engine.removeEntity(t)}createGame(){const e=new T,i=new t.Entity("game").add(new c).add(new p(e)).add(new h(e)).add(new g(this.config.width/2,25,0));return this.engine.addEntity(i),i}createWaitForClick(){if(!this.waitEntity){const e=new k;this.waitEntity=new t.Entity("wait").add(new f(e)).add(new h(e)).add(new g(this.config.width/2,this.config.height/2,0))}return this.waitEntity.get(f).startGame=!1,this.engine.addEntity(this.waitEntity),this.waitEntity}createAsteroid(e,i,a){const c=new t.Entity,l=new t.EntityStateMachine(c),u=4*(Math.random()-.5)*(50-e),p=4*(Math.random()-.5)*(50-e),y=2*Math.random()-1;l.createState("alive").add(m).withInstance(new m(u,p,y)).add(d).withInstance(new d(e)).add(h).withInstance(new h(new x(e)));const w=new S(e);return l.createState("destroyed").add(r).withInstance(new r(3)).add(h).withInstance(new h(w)).add(s).withInstance(new s(w)),c.add(new o(l)).add(new g(i,a,0)).add(new n),l.changeState("alive"),this.engine.addEntity(c),c}createSpaceship(){const e=new t.Entity,i=new t.EntityStateMachine(e);i.createState("playing").add(m).withInstance(new m(0,0,0,15)).add(y).withInstance(new y(37,39,38,100,3)).add(l).withInstance(new l(8,0,.3,2)).add(u).withInstance(new u(32)).add(d).withInstance(new d(9)).add(h).withInstance(new h(new M));const o=new E;return i.createState("destroyed").add(r).withInstance(new r(5)).add(h).withInstance(new h(o)).add(s).withInstance(new s(o)),e.add(new w(i)).add(new g(this.config.width/2,this.config.height/2,0)).add(new n),i.changeState("playing"),this.engine.addEntity(e),e}createUserBullet(e,i){const s=Math.cos(i.rotation),o=Math.sin(i.rotation),n=(new t.Entity).add(new a(e.bulletLifetime)).add(new g(s*e.offsetFromParentX-o*e.offsetFromParentY+i.x,o*e.offsetFromParentX+s*e.offsetFromParentY+i.y,0)).add(new d(0)).add(new m(150*s,150*o,0,0)).add(new h(new N));return this.engine.addEntity(n),n}}class C{constructor(t,e){this.width=t,this.height=e}}class L{constructor(){this.keys=new Int32Array(4),this.keyDownHandler=t=>{const{keyCode:e}=t,i=Math.floor(e/32);this.keys[i]|=1<<e-32*i},this.keyUpHandler=t=>{const{keyCode:e}=t,i=Math.floor(e/32);this.keys[i]&=~(1<<e-32*i)},window.addEventListener("keyup",this.keyUpHandler),window.addEventListener("keydown",this.keyDownHandler)}isDown(t){const e=Math.floor(t/32);return 0!=(this.keys[e]&1<<t-32*e)}isUp(t){return!this.isDown(t)}}const F=t.defineNode({animation:s},"AnimationNode"),I=t.defineNode({asteroid:o,position:g,collision:d,audio:n},"AsteroidCollisionNode"),P=t.defineNode({audio:n},"AudioNode"),D=t.defineNode({bullet:a},"BulletAgeNode"),A=t.defineNode({bullet:a,position:g,collision:d},"BulletCollisionNode"),O=t.defineNode({death:r},"DeathThroesNode"),G=t.defineNode({state:c},"GameNode"),X=t.defineNode({control:u,gun:l,position:g,audio:n},"GunControlNode"),Y=t.defineNode({state:c,hud:p},"HudNode"),R=t.defineNode({control:y,position:g,motion:m},"MotionControlNode"),B=t.defineNode({position:g,motion:m},"MovementNode"),U=t.defineNode({position:g,display:h},"RenderNode"),j=t.defineNode({spaceship:w,position:g,collision:d,audio:n},"SpaceshipCollisionNode"),H=t.defineNode({spaceship:w,position:g},"SpaceshipNode"),W=t.defineNode({wait:f},"WaitForStartNode");class V extends t.ListIteratingSystem{constructor(){super(F)}updateNode(t,e){t.animation.animation.animate(e)}}class z extends t.ListIteratingSystem{constructor(t,e){super(P),this.audioContext=t,this.audioDB=e}updateNode(t,e){for(const e of t.audio.toPlay){const t=this.audioDB.get(e)||null,i=this.audioContext.createBufferSource();i.buffer=t,i.connect(this.audioContext.destination),i.start(0)}t.audio.toPlay.length=0}}class $ extends t.ListIteratingSystem{constructor(t){super(D),this.creator=t}updateNode(t,e){const{bullet:i}=t;i.lifeTime-=e,i.lifeTime<=0&&this.creator.destroyEntity(t.entity)}}var q;!function(t){t[t.asteroid=0]="asteroid",t[t.ship=1]="ship",t[t.shoot=2]="shoot"}(q||(q={}));const J=[{key:q.asteroid,mp3:"652cd14a66ffc75b.mp3",ogg:"930cfba647e62b00.ogg"},{key:q.shoot,mp3:"2520559ca39a00c2.mp3",ogg:"e25571a4800a2db8.ogg"},{key:q.ship,mp3:"841ef5131f04838e.mp3",ogg:"919aafd2357b080a.ogg"}];function K(t){return i(this,void 0,void 0,(function*(){const e=new Map,s=function(){const t=document.createElement("audio"),e=t.canPlayType("audio/mpeg"),i=t.canPlayType("audio/ogg");let s=null;return"probably"===e?s="mp3":"probably"===i?s="ogg":"maybe"===e?s="mp3":"maybe"===i&&(s="ogg"),s}(),o=(s,o)=>i(this,void 0,void 0,(function*(){const i=yield fetch(s),n=yield i.arrayBuffer(),a=yield t.decodeAudioData(n);e.set(o,a)}));return s&&(yield Promise.all(J.map(t=>o(t[s],t.key)))),e}))}class Q extends t.System{constructor(t){super(),this.games=null,this.spaceships=null,this.asteroids=null,this.bullets=null,this.creator=t}addToEngine(t){this.games=t.getNodeList(G),this.spaceships=t.getNodeList(j),this.asteroids=t.getNodeList(I),this.bullets=t.getNodeList(A)}update(t){for(let t=this.bullets.head;t;t=t.next)for(let e=this.asteroids.head;e;e=e.next){if(Math.hypot(e.position.x-t.position.x,e.position.y-t.position.y)<=e.collision.radius){if(this.creator.destroyEntity(t.entity),e.collision.radius>10){const t=e.collision.radius-10;let i=e.position.x+10*Math.random()-5,s=e.position.y+10*Math.random()-5;this.creator.createAsteroid(t,i,s),i=e.position.x+10*Math.random()-5,s=e.position.y+10*Math.random()-5,this.creator.createAsteroid(t,i,s)}e.asteroid.fsm.changeState("destroyed"),e.audio.play(q.asteroid),this.games.head&&(this.games.head.state.hits+=1);break}}for(let t=this.spaceships.head;t;t=t.next)for(let e=this.asteroids.head;e;e=e.next){if(Math.hypot(e.position.x-t.position.x,e.position.y-t.position.y)<=e.collision.radius+t.collision.radius){t.spaceship.fsm.changeState("destroyed"),t.audio.play(q.ship),this.games.head&&(this.games.head.state.lives-=1);break}}}removeFromEngine(t){this.games=null,this.spaceships=null,this.asteroids=null,this.bullets=null}}class Z extends t.ListIteratingSystem{constructor(t){super(O),this.creator=t}updateNode(t,e){t.death.countdown-=e,t.death.countdown<=0&&this.creator.destroyEntity(t.entity)}}class _ extends t.System{constructor(t,e){super(),this.games=null,this.spaceships=null,this.asteroids=null,this.bullets=null,this.creator=t,this.config=e}addToEngine(t){this.games=t.getNodeList(G),this.spaceships=t.getNodeList(H),this.asteroids=t.getNodeList(I),this.bullets=t.getNodeList(A)}update(t){const e=this.games.head;if(e&&e.state.playing){if(this.spaceships.empty)if(e.state.lives>0){const t=this.config.width/2,e=this.config.height/2;let i=!0;for(let s=this.asteroids.head;s;s=s.next){if(Math.hypot(s.position.x-t,s.position.y-e)<=s.collision.radius+50){i=!1;break}}i&&this.creator.createSpaceship()}else e.state.playing=!1,this.creator.createWaitForClick();if(this.asteroids.empty&&this.bullets.empty&&this.spaceships.head){const t=this.spaceships.head;e.state.level+=1;const i=2+e.state.level;for(let e=0;e<i;e+=1){let e,i;do{e=Math.random()*this.config.width,i=Math.random()*this.config.height}while(Math.hypot(e-t.position.x,i-t.position.y)<=80);this.creator.createAsteroid(30,e,i)}}}}removeFromEngine(t){this.games=null,this.spaceships=null,this.asteroids=null,this.bullets=null}}class tt extends t.ListIteratingSystem{constructor(t,e){super(X),this.keyPoll=t,this.creator=e}updateNode(t,e){const{control:i}=t,{position:s}=t,{gun:o}=t;o.shooting=this.keyPoll.isDown(i.trigger),o.timeSinceLastShot+=e,o.shooting&&o.timeSinceLastShot>=o.minimumShotInterval&&(this.creator.createUserBullet(o,s),t.audio.play(q.shoot),o.timeSinceLastShot=0)}}class et extends t.ListIteratingSystem{constructor(){super(Y)}updateNode(t,e){t.hud.view.setLives(t.state.lives),t.hud.view.setScore(t.state.hits)}}class it extends t.ListIteratingSystem{constructor(t){super(R),this.keyPoll=t}updateNode(t,e){const{control:i}=t,{position:s}=t,{motion:o}=t;this.keyPoll.isDown(i.left)&&(s.rotation-=i.rotationRate*e),this.keyPoll.isDown(i.right)&&(s.rotation+=i.rotationRate*e),this.keyPoll.isDown(i.accelerate)&&(o.velocityX+=Math.cos(s.rotation)*i.accelerationRate*e,o.velocityY+=Math.sin(s.rotation)*i.accelerationRate*e)}}class st extends t.ListIteratingSystem{constructor(t){super(B),this.config=t}updateNode(t,e){const{position:i,motion:s}=t,{width:o,height:n}=this.config;if(i.x+=s.velocityX*e,i.y+=s.velocityY*e,i.x<0&&(i.x+=o),i.x>o&&(i.x-=o),i.y<0&&(i.y+=n),i.y>n&&(i.y-=n),i.rotation+=s.angularVelocity*e,s.damping>0){const t=Math.abs(Math.cos(i.rotation)*s.damping*e),o=Math.abs(Math.sin(i.rotation)*s.damping*e);s.velocityX>t?s.velocityX-=t:s.velocityX<-t?s.velocityX+=t:s.velocityX=0,s.velocityY>o?s.velocityY-=o:s.velocityY<-o?s.velocityY+=o:s.velocityY=0}}}class ot extends t.System{constructor(t,i={emitStageEvents:!0}){super(),this.nodes=null,this.addToDisplay=t=>{const{displayObject:e}=t.display;this.stage.addChild(e),this.options.emitStageEvents&&e.emit("addedToStage")},this.removeFromDisplay=t=>{const{displayObject:e}=t.display;this.stage.removeChild(e),this.options.emitStageEvents&&e.emit("removedFromStage")},this.container=t,this.options=i;const s=new e.Application({width:t.clientWidth,height:t.clientHeight,backgroundColor:0});this.renderer=s.renderer,this.stage=s.stage,this.view=s.view}addToEngine(t){this.container.appendChild(this.view),this.nodes=t.getNodeList(U);for(let t=this.nodes.head;t;t=t.next)this.addToDisplay(t);this.nodes.nodeAdded.add(this.addToDisplay),this.nodes.nodeRemoved.add(this.removeFromDisplay)}update(t){for(let t=this.nodes.head;t;t=t.next){const{display:e,position:i}=t;e.displayObject.setTransform(i.x,i.y,1,1,i.rotation)}this.renderer.render(this.stage)}removeFromEngine(t){this.container.removeChild(this.view),this.nodes=null}}var nt;!function(t){t[t.preUpdate=1]="preUpdate",t[t.update=2]="update",t[t.move=3]="move",t[t.resolveCollisions=4]="resolveCollisions",t[t.animate=5]="animate",t[t.render=6]="render",t[t.audio=7]="audio"}(nt||(nt={}));class at extends t.System{constructor(t){super(),this.gameNodes=null,this.waitNodes=null,this.asteroids=null,this.creator=t}addToEngine(t){this.waitNodes=t.getNodeList(W),this.gameNodes=t.getNodeList(G),this.asteroids=t.getNodeList(I)}update(t){if(!this.waitNodes||!this.gameNodes||!this.asteroids)return;const e=this.waitNodes.head,i=this.gameNodes.head;if(e&&e.wait.startGame&&i){for(let t=this.asteroids.head;t;t=t.next)t.entity&&this.creator.destroyEntity(t.entity);i.state.setForStart(),e.wait.startGame=!1,e.entity&&this.creator.destroyEntity(e.entity)}}removeFromEngine(t){this.gameNodes=null,this.waitNodes=null,this.asteroids=null}}window.addEventListener("load",()=>i(void 0,void 0,void 0,(function*(){const e=document.getElementById("game");e&&(yield function(e){return i(this,void 0,void 0,(function*(){const i=new C(e.clientWidth,e.clientHeight),s=new t.Engine,o=new b(s,i),n=new L,a=new t.FrameTickProvider,d=new AudioContext,r=yield K(d);a.add(t=>s.update(t)),a.start(),s.addSystem(new at(o),nt.preUpdate),s.addSystem(new _(o,i),nt.preUpdate),s.addSystem(new it(n),nt.update),s.addSystem(new tt(n,o),nt.update),s.addSystem(new $(o),nt.update),s.addSystem(new Z(o),nt.update),s.addSystem(new st(i),nt.move),s.addSystem(new Q(o),nt.resolveCollisions),s.addSystem(new V,nt.animate),s.addSystem(new et,nt.animate),s.addSystem(new ot(e),nt.render),s.addSystem(new z(d,r),nt.audio),o.createWaitForClick(),o.createGame()}))}(e))})))}(ASH,PIXI);
